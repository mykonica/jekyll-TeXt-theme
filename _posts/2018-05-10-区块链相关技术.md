---
layout: post
title:  "区块链"
date:   2018-05-10 9:46:40 +0800
categories: 技术
---

# 区块链相关技术
一个公开透明的可信赖的帐务系统。区块链本质上是一个去中心化的数据库。区块链的本质是解决信任问题、降低信任成本，目的是为了去中心化，去信用中介（例如银行）。

区块链技术的核心:
> * 去中心化。 这是区块链颠覆性特点，不存在任何中心机构和中心服务器，所有交易都发生在每个人电脑或手机上安装的客户端应用程序中。实现点对点直接交互，既节约资源，使交易自主化、简易化，又排除被中心化代理控制的风险。

> * 开放性。区块链可以理解为一种公共记账的技术方案，系统是完全开放透明的，账簿对所有人公开，实现数据共享，任何人都可以查账。
> 
* 不可撤销、不可篡改和加密安全性。区块链采取单向哈希算法，每个新产生的区块严格按照时间线形顺序推进，时间的不可逆性、不可撤销导致任何试图入侵篡改区块链内数据信息的行为易被追溯，导致被其他节点的排斥，造假成本极高，从而可以限制相关不法行为。

[POW(proof of work)工作量证明](http://www.infoq.com/cn/articles/bitcoin-and-block-chain-part02)
工作量证明系统（或者说协议、函数），是一种应对拒绝服务攻击和其他服务滥用的经济对策。它要求发起者进行一定量的运算，也就意味着需要消耗计算机一定的时间。工作量证明简单理解就是一份证明，用来确认你做了一定量的工作。监测工作的整个过程通常是极为低效的，而通过对工作的结果进行认证来证明完成了相应的工作量，则是一种非常高效的方式。比如现实生活中的毕业证、驾驶证等等，也是通过检验结果的方式（通过相关的考试）所取得的证明。哈希现金（hashcash）是用于比特币中的一种工作量证明机制。

<!--more-->

两种工作量证明协议：

* Challenge-response

![](/assets/images/15259543707061.jpg)

* Solution-verifiation

![](/assets/images/15259543909000.jpg)


比特币网络中任何一个节点，如果想生成一个新的区块并写入区块链，必须解出比特币网络出的工作量证明的迷题。这道题关键的三个要素是工作量证明函数、区块及难度值。工作量证明函数是这道题的计算方法，区块决定了这道题的输入数据，难度值决定了这道题的所需要的计算量。

比特币中的工作量证明函数用的是SHA256（到目前为止，还没有出现对SHA256算法的有效攻击）。难度值决定了矿工们大约需要多少次哈希运算才能产生一个合法的区块。比特币的区块大约每10分钟生成一个，难度值根据全网的算力自动调整。难度的调整是在每个完整节点中自动完成的，调整的公式为**新难度值 = 旧难度值 * ( 过去2016个区块花费时长 / 20160 分钟 )**。工作量证明需要有一个目标值。比特币工作量证明的目标值（Target）的计算公式为**目标值 = 最大目标值 / 难度值**
其中最大目标值为一个恒定值：
**0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF**。
比特币工作量证明的过程，就是通过不停的变换区块头（即尝试不同的nouce值）作为输入进行SHA256哈希运算，找出一个特定格式哈希值的过程（即要求有一定数量的前导0）。而要求的前导0的个数越多，代表难度越大。

在比特币的系统中，最重要的并不是“币”的概念，而是一个没有中心存储机构的“账本”的概念。“币”只是在这个账本上使用的记账单位。可以这么说，比特币本质就是一个基于互联网的去中心化账本，而区块链就是这个账本的名字。这里我们可以做一个形象的类比，假如区块链是一个实物账本，一个区块就相当于账本中的一页，区块中承载的信息，就是这一页上记载的交易内容。**区块链是比特币的核心与基础架构，是一个去中心化的账本系统。**

## 比特币原理

![](/assets/images/15259544137015.jpg)


![](/assets/images/15259544643416.jpg)
交易费是将交易放进账簿的矿工所收集到的一笔小额支付。

![](/assets/images/15259544857455.jpg)
交易链

比特币网络是由参与的比特币客户端联接几个其他比特币客户端组成的P2P网络。比特币网络的目的是将交易和区块传播给所有参与者。

付款方的钱包应用可以发送新的交易给其它任意一个已联接到互联网的比特币客户端。任何比特币网络节点（其它客户端）收到一个之前没见过的有效交易时会立刻将它转发给联接到自身的其它节点。因此，这个交易迅速地从P2P网络中传播开来，几秒内就能到达大多数节点。

平均每10分钟，矿工会将自上一个区块以来发生的所有交易生成一个新的区块。新交易不断地从用户钱包和应用流入比特币网络。当比特币网络上的节点看到这些交易时，会先将它们放到各自节点维护的一个临时的未经验证的交易池中。当矿工构建一个新区块时，会将这些交易从这个交易池中拿出来放到这个新区块中，然后通过尝试解决一个非常困难的问题（也叫工作量证明）以证明这个新区块的合法性。矿工一旦从网络上收到一个新区块时，会意识到在这个区块上的解题竞赛已经输掉了，会马上开始下一个新区块的挖掘工作。它会立刻将一些交易和这个新区块的数字指纹放在一起开始构建下一个新区块，并开始给它计算工作量证明。每个矿工会在他的区块中包含一个特殊的交易，将新生成的比特币（当前每区块为25比特币）作为报酬支付到他自己的比特币地址。如果他找到了使得新区块有效的解法，他就会得到这笔报酬，因为这个新区块被加入到了总区块链中，他添加的这笔报酬交易也会变成可消费的。

交易费可当作是为了包含（挖矿）一笔交易到下一个区块中的一种鼓励，也可当作是对于欺诈交易和任何种类的系统滥用，在每一笔交易上通过征收一笔小成本的税而造成的一种妨碍。交易费被挖出这个区块的矿工得到，并且记录在这个交易的区块链中。交易费基于交易的尺寸，用千字节来计算，而不是比特币的价值。交易费影响处理优先级，交易费高的交易会被尽快处理包含在下一个区块中，交易费不足的交易会被推迟处理，甚至不处理。

交易的数据结构没有交易费的字段。相反地，交易费通过所有输入的总和，以及所有输出的总和之间的差来表示。

新节点通过种子节点发现比特币网络中的对等节点。通常客户端会维持一个长期稳定运行节点的列表。也可以新节点启动时指定一个种子节点的IP。种子节点将新节点引荐给他的对等节点，而这些节点又会进一步引荐。由于节点随时可以加入和离开，节点必须持续进行两项工作，在失去已有连接时发现新节点，在其他节点启动时提供帮助。
##应用场景
[区块链技术源于比特币 现在却要改变这12个行业](http://www.haoxx.com/com/anjin2000/news/itemid-482607.html)
> 1.银行业
作为一种数字化，安全防干扰的帐户，区块链实现了银行业的核心功能：即价值的安全储存和转移中心。也就是说，在将来的几年内，一波基于区块链技术的公司或将影响到银行业。

> 2.支付和转账
区块链技术能够避开繁杂的系统，在付款人和收款人之间创造更直接的付款流程，不管是境内转账还是跨境转账，这种方式都有着低价、迅速的特点，而且无需中间手续费。

> 3.网络安全
    虽然区块链的系统是公开的，但其核验、发送等数据交流过程却采用了先进的加密技术。这种技术不仅确保了数据的正确来源，也确保了数据在中间过程不被人拦截。如果区块链技术的应用更为广泛，那么其遭受黑客袭击的概率也可能会下降，因此人们认为区块链系统要比传统系统更为稳妥。区块链系统之所以能降低传统网络安全风险，一大原因就是它解除了对中间人的需求。

> 4.选举
大家的投票“绝不可能被我们——即程序员，学校管理员或学生修改、删除。”

> 5.智能合同
智能合同实际上是在另一个物体的行动上发挥功能的电脑程序。和普通电脑程序一样，智能合同也是一种“如果-然后”功能，但区块链技术实现了这些“合同”的自动填写，无需人工介入。这种合同最终可能会取代法律行业的核心业务，即在商业和民事领域起草和管理合同的业务。

> 6.股票交易
许多年来，各个公司都在想方设法简化股票的购买、销售和交易过程，新兴的区块链技术创企认为他们能够超越以往，实现整个流程的自动化，提高安全性和效率。

Merkle tree

区块链技术的三类应用：
1. 公开区块链：比特币。公开区块链上的数据所有人都可以访问，所有人都可以发出交易等待被写入区块链。共识过程的参与者（对应比特币中的矿工）通过密码学技术以及内建的经济激励维护数据库的安全。公开区块链是完全的分布式。
2. 协作区块链：一些审计系统。参与区块链的结点是事先选好的，节点之间很可能有很好的网络连接。这样的区块链上可以采用非工作量证明的其他共识算法。
3. 私有区块链：参与的节点只有用户自己，数据的访问和使用有严格的权限管理。

根据使用目的和场景的不同，又可以分为以数字货币为目的的货币链，以记录产权为目的的产权链，以众筹为目的的众筹链等。
## 比特币应用
所谓挖到矿就是要猜到一个nonce值让该区块的摘要值小于一个会根据难度而线性调整的目标值，这也是所谓的工作量证明。简单一点说，就是重复计算去块头额哈希值，不断地改变参数，直到与哈希值匹配的一个过程。

Block Reward：每成功挖到一个矿，比特币网络给矿工的奖励。奖励的规则是比特币网络创建之初设置好的，不可修改。从#1块开始有50比特币的奖励，此后每210000个块减半。（防止通货膨胀）

客户端发起一项交易后，会广播到网络中并等待确认。网络中的节点会将一些等待确认的交易记录打包在一起（此外还要包括此前区块的哈希值等信息）（**会选择将多少条记录打包在一起？**），组成一个候选区块。然后，试图找到一个 nonce 串放到区块里，使得候选区块的 hash 结果满足一定条件（比如小于某个值）。一旦算出来这个区块在格式上就合法了，就可以进行全网广播。大家拿到提案区块，进行验证，发现确实符合约定条件了，就承认这个区块是一个合法的新区块，被添加到链上。

## Merkle tree（哈希树）
![](/assets/images/15259545224824.jpg)

默克尔树的特点是，底层数据的任何变动，都会传递到其父亲节点，一直到树根。
默克尔树的典型应用场景包括：

*   快速比较大量数据：当两个默克尔树根相同时，则意味着所代表的数据必然相同。
*   快速定位修改：例如上例中，如果 D1 中数据被修改，会影响到 N1，N4 和 Root。因此，沿着 Root --> N4 --> N1，可以快速定位到发生改变的 D1；
*   零知识证明（`证明者在不向验证者提供任何有用的信息的前提下，使验证者相信某个论断是正确的`）：例如如何证明某个数据（D0……D3）中包括给定内容 D0，很简单，构造一个默克尔树，公布 N0，N1，N4，Root，D0 拥有者可以很容易检测 D0 存在，但不知道其它内容。

##问题
*   一个区块可以包含多少条交易记录
    
    没有规定每个区块包含的交易数据，只规定了每个区块的大小为1M。
*   分布式系统的核心问题及其解决方案
*   Paxos与Raft算法
*   比特币系统中的确认(confirmation)是怎么回事
   
   第277,317号新区块诞生在另一个挖矿节点中。因为这个新区块是基于包含Alice交易的第277,316号区块的，在这个区块的基础上增加了更多的计算，因此就加强了这些交易的可信度。包含Alice交易的区块对这个交易来说算一次"证明"。基于这个区块每产生一个新区块，对这个交易来说就会增加了一次"证明"。当区块一个个堆上来时，这个交易变得指数级地越来越难被推翻，因此它在网络中得到更多信任。

![](/assets/images/15259545375449.jpg)


*   如何验证交易的合法性
    
    全索引客户端可以根据交易链回溯钱款的来源，用交易链的完整性来验证某笔交易的合法性。轻量级客户端通过确认一个交易在区块链中且在它后面有几个新区块来确认一个支付的合法性。这种方式叫做简易支付验证。

*   简易支付验证过程
*   区块链分叉的形成及解决办法


